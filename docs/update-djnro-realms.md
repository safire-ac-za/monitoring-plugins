# update-djnro-realms.pl

update-djnro-realms.pl interfaces with the [DjNRO](http://djnro.grnet.gr/) eduroam management system to automatically generate Nagios config based on test credentials supplied by IdPs and recorded in DjNRO.


## Configuration
Configuration is done in a YAML config file. By default it looks for this in `OMD_ROOT/etc/djnro-realms.cfg` for OMD systems, or `/etc/djnro-realms.cfg` on other systems.

Full documentation of the config file can be obtained from perldoc(1)

## Database configuration and rights

The DjNRO database connection string is configured as follows:

```yaml
---
djnroDSN: DBI:mysql:database=djnro;host=localhost
djnroDbPass: very_secret_password
djnroDbUser: realm_monitor
```

The script needs limited access into DjNRO's database. In particular, it needs SELECT access to the following tables: django_admin_log, django_content_type, edumanage_instrealm, edumanage_instrealmmon, edumanage_monlocalauthnparam, edumanage_name_i18n, edumanage_contact, edumanage_institutioncontactpool, edumanage_institutiondetails_contact, edumanage_institutiondetails

## Nagios templates

The generated configuration uses Nagios' template inheritance mechanism to create "default" information. The templates we use for this are as follows:

```
# Used by update-djnro-realms.pl for autogenerated per-realm services out of DjNRO
define service {
  name                           djnro-generated-realm
  host_name                      eduroam NRO
  use                            generic-pnp-service
  check_command                  check_multi!idp_realm!-s EAP_METHOD="$_SERVICEEAP_METHOD$" -s EAP_PHASE2="$_SERVICEEAP_PHASE2$" -s EAP_ANONYMOUS="$_SERVICEEAP_ANONYMOUS$" -s EAP_USERNAME="$_SERVICEEAP_USERNAME$" -s EAP_PASSWORD='$_SERVICEEAP_PASSWORD$' -s REALM="$_SERVICEREALM$"
  check_interval                 15
  first_notification_delay       45
  max_check_attempts             3
  notes                          This service was auto-generated from monitoring information supplied by the institutional administrators. Updates can be made at <a href="https://eduroam.ac.aq/manage/$_SERVICEEDITURI$">https://eduroam.ac.aq/manage/instrealmsmon</a> and are automatically applied every few hours. For queries about this realm, please contact the help desk at $_SERVICEINSTITUTION$.
  notes_url                      https://eduroam.ac.aq/manage/$_SERVICEEDITURI$
  notification_interval          10080
  notifications_enabled          1
  register                       0
  retry_interval                 2
  servicegroups                  +instrealms
  stalking_options               w,c
  _EDITURI                       instrealmsmon
  _INSTITUTION                   Home Organisation
}

# Used by update-djnro-realms.pl for autogenerated contacts out of DjNRO
define contact {
  name                           djnro-generated-contact
  alias                          DjNRO Generated Contact
  use                            generic-contact
  can_submit_commands            0
  host_notification_options      n
  host_notification_period       none
  host_notifications_enabled     0
  register                       0
  service_notification_commands  djnro-realm-notify-by-email
  service_notification_options   w,c,r
  service_notification_period    djnro-realm-contact-times
  service_notifications_enabled  1
}

# Used by update-djnro-realms.pl for autogenerated per-realm services out of DjNRO
define serviceescalation {
  name                           djnro-generated-serviceescalation
  host_name                      eduroam NRO
  contact                        escalation-contact
  first_notification             4
  last_notification              0
  notification_interval          10080
  register                       0
}

# Used by update-djnro-realms.pl for autogenerated per-realm services out of DjNRO
define servicedependency {
  name                           djnro-generated-servicedependency
  service_description            flrs-health
  hostgroup_name                 eduroam-flr-servers
  dependent_host_name            eduroam NRO
  execution_failure_criteria     n
  notification_failure_criteria  w,u,c,p
  register                       0
}
```

## Overriding DjNRO information

It is sometimes necessary to override the incoming credentials from DjNRO, for example when an IdP mandates a specific outer identity. This can be done in the config file as follows:

```yaml
---
credentialOverride:
  example.ac.za:
    anonymous: anonymous@example.ac.za
    method: PEAP
    pass: password
    phase2: MSCHAPV2
    username: username@example.ac.za
```

# Disabling contacts

Some contacts may not wish to receive notifications, and so it is possible to disable those contacts in the config file:

```yaml
---
disableContacts:
  - eduroam@tenet.ac.za
```
This mechanism is used automatically but the [notification-optout.cgi](notification-optout.md) script.
